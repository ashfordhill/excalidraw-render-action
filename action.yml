name: 'Excalidraw Render Action'
description: 'Convert Excalidraw files to PNG images'
branding:
  icon: 'image'
  color: 'purple'

inputs:
  input-dir:
    description: 'Directory containing .excalidraw files'
    required: false
    default: '.'
  output-dir:
    description: 'Directory to output PNG files (defaults to same as input directory)'
    required: false
    default: ''

runs:
  using: 'composite'
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install excalidraw-brute-export-cli
      shell: bash
      run: npm install -g excalidraw-brute-export-cli
    
    - name: Install Playwright dependencies
      shell: bash
      run: |
        npx playwright install-deps firefox
        npx playwright install firefox
    
    - name: Convert Excalidraw files to PNG
      shell: bash
      run: |
        INPUT_DIR="${{ inputs.input-dir }}"
        OUTPUT_DIR="${{ inputs.output-dir }}"
        
        if [ -z "$OUTPUT_DIR" ]; then
          OUTPUT_DIR="$INPUT_DIR"
        fi
        
        echo "Searching for .excalidraw files in: $INPUT_DIR"
        echo "Output directory: $OUTPUT_DIR"
        
        found_files=0
        while IFS= read -r -d '' file; do
          found_files=$((found_files + 1))
          
          # Use relative path from current directory
          relative_file="${file#./}"
          output_basename="${relative_file%.excalidraw}.png"
          
          if [ "$OUTPUT_DIR" != "$INPUT_DIR" ]; then
            # If output dir is different, create subdirectories in output
            file_dir=$(dirname "$relative_file")
            if [ "$file_dir" != "." ]; then
              mkdir -p "$OUTPUT_DIR/$file_dir"
              output_file="$OUTPUT_DIR/$file_dir/$(basename "$output_basename")"
            else
              mkdir -p "$OUTPUT_DIR"
              output_file="$OUTPUT_DIR/$(basename "$output_basename")"
            fi
          else
            # Same directory - use the file's directory
            file_dir=$(dirname "$relative_file")
            if [ "$file_dir" != "." ]; then
              mkdir -p "$file_dir"
              output_file="$file_dir/$(basename "$output_basename")"
            else
              output_file="$(basename "$output_basename")"
            fi
          fi
          
          echo "Converting $relative_file to $output_file"
          excalidraw-brute-export-cli \
            -i "$relative_file" \
            -o "$output_file" \
            --format png \
            --background 1 \
            --embed-scene 0 \
            --dark-mode 0 \
            --scale 1
        done < <(find "$INPUT_DIR" -name "*.excalidraw" -type f -print0)
        
        if [ $found_files -eq 0 ]; then
          echo "Warning: No .excalidraw files found in $INPUT_DIR"
        else
          echo "Successfully converted $found_files file(s)"
        fi
